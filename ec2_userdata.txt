#!/bin/bash

#当該EC2インスタンスの動的パブリックIPの取得
public_ip=$(curl inet-ip.info)

# ubuntuレイヤのインストール
sudo apt-get update
sudo apt-get -y install python3-pip python3-dev libpq-dev postgresql postgresql-contrib nginx

# postgresqlの設定
sudo -u postgres psql
CREATE DATABASE djangodb;
CREATE USER django WITH PASSWORD 'psqlmyDjango';
ALTER ROLE django SET client_encoding TO 'utf8';
ALTER ROLE django SET default_transaction_isolation TO 'read committed';
ALTER ROLE django SET timezone TO 'UTC+9';
GRANT ALL PRIVILEGES ON DATABASE djangodb TO django;
\q

# pythonレイヤのインストール
sudo -H pip3 install --upgrade pip
sudo -H pip3 install awscli --upgrade
git clone https://github.com/okmethod/mydjango.git
cd mydjango
pip install -r requirements.txt
export PATH="$PATH:/home/ubuntu/.local/bin"

# S3から設定ファイルを取得、EC2インスタンス依存項目の置換
aws s3 cp s3://private-files-for-mydjango/mydjango/.env ./
sed -i s/www.mydjangp.jp/$public_ip/ ./.env
sudo aws s3 cp s3://private-files-for-mydjango/etc/systemd/system/gunicorn.service /etc/systemd/system/
sudo aws s3 cp s3://private-files-for-mydjango/etc/systemd/system/gunicorn.socket /etc/systemd/system/
sudo aws s3 cp s3://private-files-for-mydjango/etc/nginx/sites-available/mydjango /etc/nginx/sites-available/
sudo sed -i s/www.mydjangp.jp/$public_ip/ /etc/nginx/sites-available/mydjango
sudo ln -s /etc/nginx/sites-available/mydjango /etc/nginx/sites-enabled/

# DBマイグレート
python3 manage.py migrate
#python3 manage.py runserver 0.0.0.0:8000

# staticファイルの収集
python3 manage.py collectstatic

# WSGIサーバ起動
sudo systemctl start gunicorn.socket
sudo systemctl enable --now gunicorn.socket
curl --unix-socket /home/ubuntu/mydjango/config/config.sock localhost

# WEBサーバ起動
#sudo systemctl start nginx
sudo systemctl restart nginx
